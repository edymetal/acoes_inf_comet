<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Ações</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 250px; background-color: #2c3e50; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; flex-shrink: 0; height: 100vh; }
        #sidebar h2 { color: #ffffff; margin-top: 0; margin-bottom: 20px; text-align: center; }
        #last-updated-date { font-size: 0.8em; color: #ffffff; margin-top: 5px; margin-bottom: 20px; text-align: center; } /* Changed color to white */
        #back-to-overview-btn { display: none; } /* Allow JS to control visibility */
        #dashboard-link { border-radius: 5px; margin-bottom: 20px; }
        #search-input { background-color: #e9ecef !important; color: #212529; border: 1px solid #e9ecef; } /* Light gray for search input */
        .input-group-text { background-color: #e9ecef !important; }
        #search-input::placeholder { color: #6c757d; } /* Darker placeholder color */
        #sidebar .list-group-item { background-color: #2c3e50 !important; color: #ecf0f1; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 0; } /* List item background matches sidebar, with separator */
        #sidebar .list-group-item:last-child { border-bottom: none; } /* Remove border from last item */
        #sidebar .list-group-item a { background-color: transparent; color: #ecf0f1; text-decoration: none; display: flex; align-items: center; padding: 12px 15px; border-radius: 5px; margin: 0 10px; } /* Link background transparent, use flex for icon alignment */
        #sidebar .list-group-item a:hover, #sidebar .list-group-item a.active { background-color: #34495e; color: #ffffff; } /* Darker blue-gray for active/hover state */
        #content-area { flex-grow: 1; padding: 30px; overflow-y: auto; background-color: #ffffff; }
        .summary h1 { color: #2c3e50; margin-top: 0; text-align: center; margin-bottom: 60px; }
        .summary h2 { color: #34495e; border-bottom: 2px solid #eceff1; padding-bottom: 10px; margin-top: 60px; margin-bottom: 30px; }
        
        #overview-screen { padding: 30px; text-align: center; background-color: #ffffff; display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; }
        .summary {
            max-width: 1200px; /* Garantir que o summary também tenha largura maior */
            margin: 0 auto; /* Centralizar */
        }
        .table-responsive table {
            width: 100%;
            font-size: 1em; /* Aumentar um pouco mais a fonte */
        }
        .table-responsive th, .table-responsive td {
            padding: 0.5rem; /* Reduzir o padding padrão */
        }

        .financial-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 45px; width: 100%; max-width: 1200px; margin: 0 auto; }

        .financial-card { background-color: #fff; border: 1px solid #4a90e2; border-radius: 12px; padding: 25px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); transition: transform 0.2s ease-in-out; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .financial-card:hover { transform: translateY(-5px); }
        .financial-card .icon { font-size: 2.5em; color: #4a90e2; margin-bottom: 10px; }
        .financial-card .label { font-size: 0.9em; font-weight: 700; color: #6c757d; text-transform: uppercase; display: block; margin-bottom: 8px; text-align: center; }
        .financial-card .value { font-size: 1.8em; font-weight: 600; color: #2c3e50; text-align: center; }
        .business-summary { background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .table-responsive table {
            width: 100%;
            font-size: 1em; /* Aumentar um pouco mais a fonte */
            table-layout: fixed; /* Adicionado */
        }
        .table-responsive {
            max-height: 500px; /* Limitar a altura e adicionar rolagem vertical */
            overflow-y: auto;
        }

        .sortable {
            cursor: pointer;
        }

        .sortable:hover {
            background-color: #f0f0f0;
        }

        #menu-toggle-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 1.8em;
            line-height: 1;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100% !important;
                z-index: 1000;
                transition: left 0.3s ease-in-out;
                width: 280px !important;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }

            #sidebar.visible {
                left: 0;
            }

            #content-area {
                width: 100%;
                padding: 15px;
            }
            
            #menu-toggle-btn {
                display: block;
            }

            #overview-screen, #details-screen {
                padding-top: 50px;
            }

            .financial-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button id="menu-toggle-btn"><i class="bi bi-list"></i></button>
    <div id="sidebar" class="d-flex flex-column p-3 text-white">
        <p id="last-updated-date" class="text-end mb-4">Atualizado em: 02/10/2025</p>
        <a href="https://www.edney.it" class="d-block text-center fw-bold text-uppercase text-light py-3 fs-5" style="text-decoration: none;"><i class="bi bi-house me-2"></i>Home</a>
        <a id="dashboard-link" class="d-block text-center fw-bold text-uppercase text-light py-3 fs-5" style="text-decoration: none;"><i class="bi bi-speedometer me-2"></i>Dashboard</a>
        <h2 class="text-center mt-4 mb-3">Ações</h2>
        <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="search-input" class="form-control" placeholder="Buscar Ação...">
        </div>

        <ul id="item-list" class="list-group list-group-flush"></ul>
    </div>
    <div id="content-area">
        <div id="overview-screen">
            <h1>Dashboard de Análise de Ações</h1>
            <p>Visão geral do mercado de ações.</p>
            <div class="financial-info-grid">
                <div class="financial-card">
                    <i class="bi bi-bar-chart-line icon"></i>
                    <span class="label">Total de Ações</span>
                    <span class="value" id="total-acoes"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-cash-stack icon"></i>
                    <span class="label">Média Capitalização de Mercado</span>
                    <span class="value" id="avg-market-cap"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-graph-up-arrow icon"></i>
                    <span class="label">Maior P/L</span>
                    <span class="value" id="highest-pe"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-graph-down-arrow icon"></i>
                    <span class="label">Menor P/L</span>
                    <span class="value" id="lowest-pe"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-percent icon"></i>
                    <span class="label">Maior Dividend Yield</span>
                    <span class="value" id="highest-dividend-yield"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-graph-up-arrow icon"></i>
                    <span class="label">Maior Variação da Média</span>
                    <span class="value" id="highest-avg-variation"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-graph-down-arrow icon"></i>
                    <span class="label">Menor Variação da Média</span>
                    <span class="value" id="lowest-avg-variation"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-arrow-up-right icon"></i>
                    <span class="label">Maior Acima do Máx. 12M</span>
                    <span class="value" id="highest-above-12m-max"></span>
                </div>
            </div>
            <p class="mt-4" id="overview-last-updated-date"></p>
            <div class="summary mt-5">
                <h2>Todas as Ações</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th data-column="acao" class="sortable">Ação <i class="bi bi-arrow-down-up"></i></th>
                                <th data-column="pl" class="sortable">P/L (Trailing) <i class="bi bi-arrow-down-up"></i></th>
                                <th data-column="dy" class="sortable">Dividend Yield <i class="bi bi-arrow-down-up"></i></th>
                                <th data-column="variacao" class="sortable">Variação da Média <i class="bi bi-arrow-down-up"></i></th>
                                <th data-column="acima_max" class="sortable">% Acima Máx. 12M <i class="bi bi-arrow-down-up"></i></th>
                            </tr>
                        </thead>
                        <tbody id="all-acoes-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="details-screen" style="display: none;">
            <!-- Conteúdo detalhado da Ação será gerado aqui -->
        </div>
    </div>

    <script>
            let acaoData = {};
            let allAcaoCodes = [];
            let historicoChart = null;

            // Função para carregar os dados do JSON
            async function loadAcaoData() {
                try {
                    const response = await fetch('db/dados_acoes.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Erro ao carregar dados_acoes.json:', error);
                    return {};
                }
            }

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const itemList = document.getElementById('item-list');
            const searchInput = document.getElementById('search-input');
            const overviewScreen = document.getElementById('overview-screen');
            const detailsScreen = document.getElementById('details-screen');
            const dashboardLink = document.getElementById('dashboard-link');
            const allAcoesScreen = document.getElementById('all-acoes-screen');
            const backToOverviewBtnAllAcoes = document.getElementById('back-to-overview-btn-all-acoes');
            let acaoData = await loadAcaoData(); // Carrega os dados de forma assíncrona
            let allAcaoCodes = [];
            let historicoChart = null;

            if (backToOverviewBtnAllAcoes) {
                backToOverviewBtnAllAcoes.addEventListener('click', showOverviewScreen);
            }

            const formatValue = (value, type = 'default') => {
                if (value === null || typeof value === 'undefined') return 'N/A';
                if (type === 'currency') return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); // Usar USD como padrão ou inferir
                if (type === 'number') return value.toLocaleString('en-US');
                if (type === 'percent') return `${(value * 100).toFixed(2)}%`;
                return value;
            };

            const lastUpdatedElement = document.getElementById('last-updated-date');
            if (acaoData.last_updated && lastUpdatedElement) {
                const date = new Date(acaoData.last_updated);
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                lastUpdatedElement.innerHTML = ''; // Limpa o conteúdo existente (incluindo o ícone)
                lastUpdatedElement.textContent = `Atualizado em: ${date.toLocaleDateString('pt-BR', options)}`;
            }

            // Remover a propriedade last_updated do objeto acaoData para que não seja tratada como um ticker
            const lastUpdatedDate = acaoData.last_updated; // Salva a data antes de deletar
            delete acaoData.last_updated;

            allAcaoCodes = Object.keys(acaoData).sort();
            initializeDashboard();

            function initializeDashboard() {
                if (allAcaoCodes.length === 0) {
                    overviewScreen.innerHTML = '<h1>Nenhuma Ação para exibir</h1><p>Execute o script de análise para gerar os dados.</p>';
                    return;
                }
                renderList(allAcaoCodes);
                showOverviewScreen();

                // --- Novo código para calcular e exibir métricas gerais ---
                const totalAcoes = allAcaoCodes.length;
                let totalMarketCap = 0;
                let highestPE = { value: -Infinity, code: '' };
                let lowestPE = { value: Infinity, code: '' };
                let highestDividendYield = { value: -Infinity, code: '' };
                let highestAvgVariation = { value: -Infinity, code: '' };
                let lowestAvgVariation = { value: Infinity, code: '' };
                let highestAbove12MMax = { value: -Infinity, code: '' };

                allAcaoCodes.forEach(code => {
                    const data = acaoData[code];
                    if (data && data.info) {
                        if (data.info.marketCap) {
                            totalMarketCap += data.info.marketCap;
                        }
                        if (data.info.trailingPE && data.info.trailingPE !== null && data.info.trailingPE !== 'N/A') {
                            if (data.info.trailingPE > highestPE.value) {
                                highestPE.value = data.info.trailingPE;
                                highestPE.code = code;
                            }
                            if (data.info.trailingPE < lowestPE.value) {
                                lowestPE.value = data.info.trailingPE;
                                lowestPE.code = code;
                            }
                        }
                        if (data.info.dividendYield && data.info.dividendYield !== null && data.info.dividendYield !== 'N/A') {
                            if (data.info.dividendYield / 100 > highestDividendYield.value) {
                                highestDividendYield.value = data.info.dividendYield / 100;
                                highestDividendYield.code = code;
                            }
                        }
                        if (data.info.percentual_diferenca_media && data.info.percentual_diferenca_media !== null && data.info.percentual_diferenca_media !== 'N/A') {
                            const variation = Math.abs(data.info.percentual_diferenca_media); // Usar valor absoluto para "maior variação"
                            if (variation > highestAvgVariation.value) {
                                highestAvgVariation.value = variation;
                                highestAvgVariation.code = code;
                            }
                            if (variation < lowestAvgVariation.value) {
                                lowestAvgVariation.value = variation;
                                lowestAvgVariation.code = code;
                            }
                        }
                        if (data.info.currentPrice && data.info.fiftyTwoWeekHigh) {
                            const percentAboveHigh = ((data.info.currentPrice - data.info.fiftyTwoWeekHigh) / data.info.fiftyTwoWeekHigh) * 100;
                            if (percentAboveHigh > highestAbove12MMax.value) {
                                highestAbove12MMax.value = percentAboveHigh;
                                highestAbove12MMax.code = code;
                            }
                        }
                    }
                });

                const avgMarketCap = totalAcoes > 0 ? totalMarketCap / totalAcoes : 0;

                document.getElementById('total-acoes').textContent = totalAcoes;
                document.getElementById('avg-market-cap').textContent = formatValue(avgMarketCap, 'currency');
                document.getElementById('highest-pe').textContent = highestPE.code ? `${highestPE.code} (${formatValue(highestPE.value, 'number')})` : 'N/A';
                document.getElementById('lowest-pe').textContent = lowestPE.code ? `${lowestPE.code} (${formatValue(lowestPE.value, 'number')})` : 'N/A';
                document.getElementById('highest-dividend-yield').textContent = highestDividendYield.code ? `${highestDividendYield.code} (${formatValue(highestDividendYield.value, 'percent')})` : 'N/A';
                document.getElementById('highest-avg-variation').textContent = highestAvgVariation.code ? `${highestAvgVariation.code} (${formatValue(highestAvgVariation.value / 100, 'percent')})` : 'N/A';
                document.getElementById('lowest-avg-variation').textContent = lowestAvgVariation.code ? `${lowestAvgVariation.code} (${formatValue(lowestAvgVariation.value / 100, 'percent')})` : 'N/A';
                document.getElementById('highest-above-12m-max').textContent = highestAbove12MMax.code ? `${highestAbove12MMax.code} (${formatValue(highestAbove12MMax.value / 100, 'percent')})` : 'N/A';

                if (lastUpdatedDate) {
                    const date = new Date(lastUpdatedDate);
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                    document.getElementById('overview-last-updated-date').textContent = `Última atualização: ${date.toLocaleDateString('pt-BR', options)}`;
                }

                // Lógica para popular a tabela de todas as ações
                const allAcoesTableBody = document.getElementById('all-acoes-table-body');
                allAcoesTableBody.innerHTML = ''; // Limpar conteúdo anterior

                allAcaoCodes.forEach(code => {
                    const data = acaoData[code];
                    if (data && data.info) {
                        const info = data.info;

                        const trailingPE = formatValue(info.trailingPE, 'number');
                        const dividendYield = formatValue(info.dividendYield / 100, 'percent');
                        const percentualDiferencaMedia = formatValue(info.percentual_diferenca_media / 100, 'percent');

                        let percentAboveHigh = 'N/A';
                        if (info.currentPrice && info.fiftyTwoWeekHigh) {
                            percentAboveHigh = formatValue(((info.currentPrice - info.fiftyTwoWeekHigh) / info.fiftyTwoWeekHigh) * 100 / 100, 'percent');
                        }

                        const row = `
                            <tr>
                                <td>${code}</td>
                                <td>${trailingPE}</td>
                                <td>${dividendYield}</td>
                                <td>${percentualDiferencaMedia}</td>
                                <td>${percentAboveHigh}</td>
                            </tr>
                        `;
                        allAcoesTableBody.innerHTML += row;
                    }
                });
                // --- Fim do novo código ---

                // Adicionar event listeners para ordenação da tabela
                let currentSort = { column: null, dir: 'asc' };

                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', () => {
                        const table = header.closest('table');
                        const tbody = table.querySelector('tbody');
                        const column = header.dataset.column;

                        if (currentSort.column === column) {
                            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSort.column = column;
                            currentSort.dir = 'asc';
                        }

                        // Remover setas de ordenação de outros cabeçalhos
                        table.querySelectorAll('th i').forEach(i => {
                            i.classList.remove('bi-arrow-down', 'bi-arrow-up');
                            i.classList.add('bi-arrow-down-up');
                        });

                        // Atualizar seta do cabeçalho atual
                        const icon = header.querySelector('i');
                        icon.classList.remove('bi-arrow-down-up');
                        if (currentSort.dir === 'asc') {
                            icon.classList.add('bi-arrow-up');
                        } else {
                            icon.classList.add('bi-arrow-down');
                        }

                        const rows = Array.from(tbody.querySelectorAll('tr'));

                        rows.sort((a, b) => {
                            let aVal = a.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText;
                            let bVal = b.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText;

                            // Converter para número se possível
                            const aNum = parseFloat(aVal.replace('%', '').replace(',', '.'));
                            const bNum = parseFloat(bVal.replace('%', '').replace(',', '.'));

                            if (!isNaN(aNum) && !isNaN(bNum)) {
                                aVal = aNum;
                                bVal = bNum;
                            } else {
                                aVal = aVal.toLowerCase();
                                bVal = bVal.toLowerCase();
                            }

                            if (aVal < bVal) {
                                return currentSort.dir === 'asc' ? -1 : 1;
                            }
                            if (aVal > bVal) {
                                return currentSort.dir === 'asc' ? 1 : -1;
                            }
                            return 0;
                        });

                        rows.forEach(row => tbody.appendChild(row));
                    });
                });

                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredCodes = allAcaoCodes.filter(code => code.toLowerCase().includes(searchTerm));
                    renderList(filteredCodes);
                });

                dashboardLink.addEventListener('click', showOverviewScreen);
            }

            function renderList(codesToRender) {
                itemList.innerHTML = codesToRender.map(code => `<li class="list-group-item"><a class="list-group-item-action text-white" data-acao="${code}"><i class="bi bi-graph-up me-2"></i>${code}</a></li>`).join('');
                itemList.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        const acaoCode = this.getAttribute('data-acao');
                        document.querySelectorAll('#item-list a.active').forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        renderAcaoDetails(acaoCode);
                    });
                });
            }

            function renderAcaoDetails(acaoCode) {
                const data = acaoData[acaoCode];
                if (!data || !data.info) { 
                    detailsScreen.innerHTML = `<h1>Dados não encontrados para ${acaoCode}</h1>`;
                    return;
                }

                const info = data.info;



                const iconMap = {
                    'Preço Atual': 'bi-cash-coin',
                    'Setor': 'bi-building',
                    'Indústria': 'bi-gear',
                    'Capitalização de Mercado': 'bi-cash-stack',
                    'P/L (Trailing)': 'bi-graph-up-arrow',
                    'P/L (Forward)': 'bi-graph-up-arrow',
                    'Preço/Vendas (TTM)': 'bi-currency-dollar',
                    'Máx. 12 Meses': 'bi-arrow-up-right',
                    'Mín. 12 Meses': 'bi-arrow-down-left',
                    'Dividend Yield': 'bi-percent'
                };

                const financialCards = [
                    { label: 'Preço Atual', value: formatValue(info.currentPrice, 'currency') },
                    { label: 'Setor', value: info.sector },
                    { label: 'Indústria', value: info.industry },
                    { label: 'Capitalização de Mercado', value: formatValue(info.marketCap, 'currency') },
                    { label: 'P/L (Trailing)', value: formatValue(info.trailingPE, 'number') },
                    { label: 'P/L (Forward)', value: formatValue(info.forwardPE, 'number') },
                    { label: 'Preço/Vendas (TTM)', value: formatValue(info.priceToSalesTrailing12Months, 'number') },
                ];

                const anuaisCards = [
                    { label: 'Máx. 12 Meses', value: formatValue(info.fiftyTwoWeekHigh, 'currency') },
                    { label: 'Mín. 12 Meses', value: formatValue(info.fiftyTwoWeekLow, 'currency') },
                    { label: 'Média 12 Meses', value: formatValue(info.media_12_meses, 'currency') },
                    { label: 'Dividend Yield', value: formatValue(info.dividendYield / 100, 'percent') },
                ];

                if (info.currentPrice && info.fiftyTwoWeekHigh) {
                    const percentAboveHigh = ((info.currentPrice - info.fiftyTwoWeekHigh) / info.fiftyTwoWeekHigh) * 100;
                    const percentAboveHighCard = {
                        label: 'Acima do Máx. 12M',
                        value: `${formatValue(percentAboveHigh / 100, 'percent')}`,
                        icon: percentAboveHigh > 0 ? 'bi-graph-up' : 'bi-graph-down',
                        color: percentAboveHigh > 0 ? '#28a745' : '#dc3545'
                    };
                    anuaisCards.push(percentAboveHighCard);
                }

                if (info.acima_da_media !== undefined) {
                    const acimaDaMedia = info.acima_da_media === 'True';
                    const percentualCard = {
                        label: 'Variação da Média',
                        value: `${formatValue(info.percentual_diferenca_media / 100, 'percent')}`,
                        icon: acimaDaMedia ? 'bi-arrow-up' : 'bi-arrow-down',
                        color: acimaDaMedia ? '#28a745' : '#dc3545'
                    };
                    anuaisCards.push(percentualCard);
                }

                const cardsHTML = financialCards.map(card => `
                    <div class="financial-card">
                        <i class="bi ${card.icon || iconMap[card.label] || 'bi-info-circle'} icon" style="color: ${card.color || '#4a90e2'};"></i>
                        <span class="label">${card.label}</span>
                        <span class="value">${card.value}</span>
                    </div>
                `).join('');

                const anuaisCardsHTML = anuaisCards.map(card => `
                    <div class="financial-card">
                        <i class="bi ${card.icon || iconMap[card.label] || 'bi-info-circle'} icon" style="color: ${card.color || '#4a90e2'};"></i>
                        <span class="label">${card.label}</span>
                        <span class="value">${card.value}</span>
                    </div>
                `).join('');

                detailsScreen.innerHTML = `
                    <div class="summary">
                        <h1><a href="${info.website}" target="_blank" style="text-decoration: none; color: inherit;">${info.longName || acaoCode} (${acaoCode}) <i class="bi bi-box-arrow-up-right fs-5"></i></a></h1>
                        
                        <h2>Dados Financeiros</h2>
                        <div class="financial-info-grid">${cardsHTML}</div>

                        <h2>Análise de 12 Meses</h2>
                        <div class="financial-info-grid">${anuaisCardsHTML}</div>

                        <h2>Histórico de Preços (1 Ano)</h2>
                        <div class="chart-container" style="position: relative; height: 50vh; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                            <canvas id="historicoChart"></canvas>
                        </div>

                        <h2>Resumo do Negócio</h2>
                        <div class="business-summary">
                            <p>${info.longBusinessSummary || 'Resumo não disponível.'}</p>
                        </div>
                    </div>`;
                
                renderHistoricoChart(data.historico);
                
                overviewScreen.style.display = 'none';
                detailsScreen.style.display = 'block';
                dashboardLink.style.display = 'block';
                dashboardLink.classList.remove('active');
            }

            function renderHistoricoChart(historicoData) {
                if (historicoChart) {
                    historicoChart.destroy();
                }

                const ctx = document.getElementById('historicoChart').getContext('2d');
                
                historicoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Preço de Fechamento',
                            data: historicoData.map(item => ({ x: new Date(item.Date), y: item.Close })),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            fill: 'start',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month'
                                },
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Preço de Fechamento (USD)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }

            function showOverviewScreen() {
                overviewScreen.style.display = 'flex';
                detailsScreen.style.display = 'none';
                dashboardLink.style.display = 'block';
                document.querySelectorAll('#item-list a.active').forEach(link => link.classList.remove('active'));
                dashboardLink.classList.add('active');
            }

            initializeDashboard();

            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebar = document.getElementById('sidebar');
            const contentArea = document.getElementById('content-area');

            if (menuToggleBtn) {
                menuToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.toggle('visible');
                });
            }

            // Hide sidebar when clicking outside of it
            contentArea.addEventListener('click', () => {
                if (sidebar.classList.contains('visible')) {
                    sidebar.classList.remove('visible');
                }
            });

            sidebar.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Hide sidebar when an item link is clicked on mobile
            itemList.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && e.target.closest('a')) {
                    sidebar.classList.remove('visible');
                }
            });

            // Hide sidebar when a main navigation link is clicked on mobile
            document.querySelectorAll('#sidebar > a').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('visible');
                    }
                });
            });
        });
    </script>
</body>
</html>

